\documentclass[11pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage{graphicx}
\usepackage{booktabs}
\usepackage{float}
\usepackage{hyperref}
\usepackage{siunitx}
\usepackage{listings}
\usepackage{xcolor}
\usepackage[margin=2.5cm]{geometry}

\title{{\Huge\textbf{Experiment Analysis Report: {{metadata.experimentId}}}}}
\author{Generated by OptimaCore Analysis Engine}
\date{\today}

\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                 
    tabsize=2
}

\lstset{style=mystyle}

\begin{document}

\maketitle
\thispagestyle{empty}

\begin{abstract}
This report presents the analysis of experiment \textbf{{{metadata.experimentId}}} conducted on {{formatDate metadata.timestamp}}. The experiment compared {{metadata.variants.length}} variants with the goal of {{experimentPurpose}}. The analysis includes statistical tests for significance and effect sizes to determine the impact of different variants on the measured metrics.
\end{abstract}

\tableofcontents
\newpage

\section{Introduction}

\subsection{Experiment Overview}
\begin{table}[H]
    \centering
    \begin{tabular}{ll}
        \toprule
        \textbf{Property} & \textbf{Value} \\
        \midrule
        Experiment ID & {{metadata.experimentId}} \\
        Start Time & {{formatDate metadata.startTime}} \\
        End Time & {{formatDate metadata.endTime}} \\
        Total Variants & {{metadata.variants.length}} \\
        Storage Sources & {{join metadata.storageSources ", "}} \\
        Total Metrics & {{metadata.metrics.length}} \\
        \bottomrule
    \end{tabular}
    \caption{Experiment Metadata}
    \label{tab:metadata}
\end{table}

\subsection{Variants}
\begin{table}[H]
    \centering
    \begin{tabular}{llll}
        \toprule
        \textbf{Variant} & \textbf{Description} & \textbf{Sample Size} & \textbf{Storage} \\
        \midrule
        {{#each variants}}
        {{@key}} & {{this.description}} & {{this.sampleSize}} & {{this.storageSource}} \\
        {{/each}}
        \bottomrule
    \end{tabular}
    \caption{Variant Descriptions}
    \label{tab:variants}
\end{table}

\section{Methodology}

\subsection{Statistical Analysis}
The following statistical methods were employed in this analysis:

\begin{itemize}
    \item \textbf{T-tests}: For comparing means between two variants
    \item \textbf{ANOVA}: For comparing means across multiple variants
    \item \textbf{Effect Size}: Cohen's d for t-tests, $\eta^2$ (eta squared) for ANOVA
    \item \textbf{Significance Level}: $\alpha = {{metadata.alpha}}$
\end{itemize}

\section{Results}

\subsection{Overall Performance}
{{#if hasFigures}}
\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{{figurePaths.performance}}
    \caption{Performance comparison across variants}
    \label{fig:performance}
\end{figure}
{{/if}}

\subsection{Metric-wise Analysis}

{{#each metrics}}
\subsubsection{{{@key}}}

{{#if this.hasSignificantResults}}
\textbf{Significant differences found} (p < {{formatNumber this.minPValue 3}})

{{#if this.anova}}
\paragraph{ANOVA Results}
\begin{table}[H]
    \centering
    \begin{tabular}{lrrrrrr}
        \toprule
        \textbf{Source} & \textbf{SS} & \textbf{df} & \textbf{MS} & \textbf{F} & \textbf{p-value} & $\eta^2$ \\
        \midrule
        Between & {{formatNumber this.anova.ss.between 2}} & {{this.anova.df.between}} & {{formatNumber this.anova.ms.between 2}} & {{formatNumber this.anova.fValue 2}} & {{formatPValue this.anova.pValue}} & {{formatNumber this.anova.effectSize.etaSquared 3}} \\
        Within & {{formatNumber this.anova.ss.within 2}} & {{this.anova.df.within}} & {{formatNumber this.anova.ms.within 2}} & & & \\
        Total & {{formatNumber this.anova.ss.total 2}} & {{this.anova.df.total}} & & & & \\
        \bottomrule
    \end{tabular}
    \caption{ANOVA results for {{@key}}}
    \label{tab:anova-{{slugify @key}}}
\end{table}
{{/if}}

{{#if this.pairwise}}
\paragraph{Pairwise Comparisons}
\begin{table}[H]
    \centering
    \begin{tabular}{lrrrrr}
        \toprule
        \textbf{Comparison} & \textbf{Mean Diff.} & \textbf{95\% CI} & \textbf{t-value} & \textbf{p-value} & \textbf{Cohen's d} \\
        \midrule
        {{#each this.pairwise}}
        {{this.variant1}} vs {{this.variant2}} & {{formatNumber this.meanDiff 2}} & [{{formatNumber this.ci.[0] 2}}, {{formatNumber this.ci.[1] 2}}] & {{formatNumber this.tValue 2}} & {{formatPValue this.pValue}} & {{formatNumber this.effectSize.cohensD 2}} \\
        {{/each}}
        \bottomrule
    \end{tabular}
    \caption{Pairwise comparisons for {{@key}}}
    \label{tab:pairwise-{{slugify @key}}}
\end{table}
{{/if}}
{{else}}
No significant differences found between variants for this metric.
{{/if}}

{{/each}}

\section{Discussion}

\subsection{Key Observations}
{{#if hasSignificantResults}}
The analysis revealed statistically significant differences in the following metrics:
\begin{itemize}
    {{#each significantMetrics}}
    \item \textbf{{{this}}}: {{lookup ../metricInterpretations @index}}
    {{/each}}
\end{itemize}
{{else}}
No statistically significant differences were observed in the measured metrics across variants.
{{/if}}

\subsection{Limitations}
\begin{itemize}
    \item Sample sizes varied across variants
    \item Potential confounding variables: {{metadata.limitations}}
\end{itemize}

\section{Conclusion}
{{#if hasSignificantResults}}
The experiment demonstrated statistically significant differences in performance across variants. The most notable findings include:
\begin{enumerate}
    \item {{conclusionPoint1}}
    \item {{conclusionPoint2}}
\end{enumerate}
{{else}}
The experiment did not demonstrate statistically significant differences in the measured metrics across variants, suggesting that the tested variations did not have a meaningful impact on the observed outcomes.
{{/if}}

\appendix
\section{Raw Data Summary}
\begin{lstlisting}[language=json]
{{toJSON metadata}}
\end{lstlisting}

\section{Additional Notes}
{{metadata.notes}}

\end{document}
